<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ç«‹å˜‰ç¾©å¤§å­¸ - 2026 æ–°æ˜¥åœ˜æ‹œå ±åˆ°ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --ncyu-red: #800000;
            --ncyu-red-dark: #5a0000;
            --bg-color: #f0f2f5;
        }
        body { 
            background-color: var(--bg-color); 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* èƒŒæ™¯è£é£¾ */
        .bg-decoration {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 35vh;
            background: linear-gradient(135deg, var(--ncyu-red) 0%, var(--ncyu-red-dark) 100%);
            z-index: -1;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .checkin-card {
            width: 100%;
            max-width: 850px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            border: none;
            animation: fadeIn 0.8s ease-out;
        }

        .card-header-custom {
            background: white;
            padding: 40px 30px 20px 30px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .ncyu-logo-text {
            color: var(--ncyu-red);
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .status-bar {
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .status-open { background-color: #d1e7dd; color: #0f5132; }   /* ç¶ è‰²: é€²è¡Œä¸­ */
        .status-closed { background-color: #f8d7da; color: #842029; } /* ç´…è‰²: é—œé–‰ */
        .status-wait { background-color: #fff3cd; color: #664d03; }   /* é»ƒè‰²: ç­‰å¾… */
        .status-loading { background-color: #e2e3e5; color: #41464b; } /* ç°è‰²: é€£ç·šä¸­ */

        .content-section { padding: 50px; }
        
        .big-input { 
            height: 80px; 
            font-size: 36px; 
            text-align: center; 
            letter-spacing: 4px;
            border: 3px solid #ced4da;
            border-radius: 12px !important;
            font-weight: bold;
            color: #333;
            transition: all 0.2s;
            text-transform: uppercase; /* å¼·åˆ¶å¤§å¯« */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .big-input:focus {
            border-color: var(--ncyu-red);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.25);
            outline: none;
        }
        .big-input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            border-color: #adb5bd;
        }

        /* çµæœé¡¯ç¤ºå€ */
        .result-box {
            display: none; 
            margin-top: 30px;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        /* å·¦å´ç‹€æ…‹æ¢è£é£¾ */
        .result-box::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 8px;
        }
        .res-success { background-color: #d1e7dd; color: #0f5132; }
        .res-success::before { background-color: #198754; }
        
        .res-repeat { background-color: #fff3cd; color: #664d03; }
        .res-repeat::before { background-color: #ffc107; }
        
        .res-error { background-color: #f8d7da; color: #842029; }
        .res-error::before { background-color: #dc3545; }

        .btn-submit {
            background-color: var(--ncyu-red);
            border-color: var(--ncyu-red);
            font-size: 1.2rem;
            padding: 15px;
            font-weight: bold;
        }
        .btn-submit:hover:not(:disabled) {
            background-color: #a31a1a;
            border-color: #a31a1a;
        }

        .server-info {
            position: fixed;
            bottom: 15px;
            right: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.8);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="bg-decoration"></div>

    <div class="main-container">
        <div class="checkin-card">
            
            <div class="card-header-custom">
                <h1 class="ncyu-logo-text display-5">åœ‹ç«‹å˜‰ç¾©å¤§å­¸</h1>
                <p class="text-muted fs-4 mb-0">2026 æ–°æ˜¥åœ˜æ‹œå ±åˆ°ç³»çµ±</p>
            </div>

            <div id="system-status-bar" class="status-loading">
                <i class="fas fa-circle-notch fa-spin"></i> æ­£åœ¨é€£ç·šä¼ºæœå™¨...
            </div>

            <div class="content-section">
                
                <label for="qrcode-input" class="form-label h4 mb-4 text-center d-block text-secondary">
                    <i class="fas fa-qrcode me-2"></i>è«‹æƒæ QR Code æˆ–è¼¸å…¥è­˜åˆ¥ç¢¼
                </label>

                <div class="input-group mb-4">
                    <input type="text" id="qrcode-input" class="form-control big-input" 
                           placeholder="ç³»çµ±é€£ç·šä¸­..." disabled autocomplete="off" autofocus>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-submit" id="btn-submit" disabled>
                        <i class="fas fa-check-circle me-2"></i>ç¢ºèªå ±åˆ° (Enter)
                    </button>
                </div>

                <div id="result-area" class="result-box">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i id="res-icon" class="fas fa-check-circle fa-2x me-3"></i>
                        <h2 id="res-title" class="fw-bold mb-0">å ±åˆ°æˆåŠŸ</h2>
                    </div>
                    <div class="fs-3 fw-bold mt-2" id="res-name">ç‹å°æ˜</div>
                    <div class="fs-5 text-muted" id="res-dept">äººäº‹å®¤</div>
                    <hr>
                    <div class="text-muted small mt-2" id="res-time">å ±åˆ°æ™‚é–“: 10:00:00</div>
                </div>

            </div>
        </div>
    </div>

    <div class="server-info">
        <i class="fas fa-server me-2"></i>
        <span id="server-status-text">é€£ç·šä¸­...</span>
        <span class="mx-2">|</span>
        <i class="far fa-clock me-1"></i>
        <span id="server-time-display">--:--:--</span>
        <span class="mx-2">|</span>
        <span id="total-count-badge" class="badge bg-secondary">å·²å ±åˆ°: 0</span>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <script>
        // ==========================================
        // å‰ç«¯é‚è¼¯æ ¸å¿ƒ (Check-in Logic)
        // ==========================================
        
        // DOM å…ƒç´ 
        const els = {
            input: document.getElementById('qrcode-input'),
            btn: document.getElementById('btn-submit'),
            statusBar: document.getElementById('system-status-bar'),
            resultBox: document.getElementById('result-area'),
            resIcon: document.getElementById('res-icon'),
            resTitle: document.getElementById('res-title'),
            resName: document.getElementById('res-name'),
            resDept: document.getElementById('res-dept'),
            resTime: document.getElementById('res-time'),
            serverTime: document.getElementById('server-time-display'),
            serverStatus: document.getElementById('server-status-text'),
            countBadge: document.getElementById('total-count-badge'),
            audio: document.getElementById('audio-player')
        };

        // ç‹€æ…‹è®Šæ•¸
        let isSystemLocked = true;
        let isProcessing = false;
        let resultTimer = null;
        let soundSettings = {}; // å„²å­˜å¾å¾Œç«¯å–å¾—çš„éŸ³æ•ˆè·¯å¾‘

        // 1. åˆå§‹åŒ–
        async function init() {
            els.input.focus();
            
            // è¼‰å…¥éŸ³æ•ˆè¨­å®š
            try {
                const res = await window.lotteryAPI.invoke('get-settings');
                if (res.success && res.data) {
                    // æ ¹æ“š settings-ipc.js çš„çµæ§‹
                    soundSettings = {
                        success: res.data.audio_celebrate || res.data.audio_pop, 
                        repeat: res.data.audio_exciting, // æˆ–å…¶ä»–éŸ³æ•ˆ
                        vip: res.data.audio_opening // å‡è¨­ VIP ç”¨é–‹å ´éŸ³æ•ˆ
                    };
                }
            } catch(e) { console.error("ç„¡æ³•è¼‰å…¥éŸ³æ•ˆè¨­å®š", e); }

            // ç¶å®šäº‹ä»¶
            els.btn.addEventListener('click', handleCheckIn);
            els.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleCheckIn();
            });

            // å•Ÿå‹•ç‹€æ…‹è¼ªè©¢
            checkSystemStatus();
            setInterval(checkSystemStatus, 3000); // æ¯3ç§’åŒæ­¥ä¸€æ¬¡
        }

        // 2. æ ¸å¿ƒï¼šæª¢æŸ¥ç³»çµ±ç‹€æ…‹ (Polling)
        async function checkSystemStatus() {
            try {
                // å‘¼å«å¾Œç«¯ (é€™æ˜¯æˆ‘å€‘å‰›å‰›åœ¨ settings-ipc.js å¯«å¥½çš„æ¬Šå¨é‚è¼¯)
                const res = await window.lotteryAPI.invoke('get-checkin-status');
                
                // æ›´æ–°å³ä¸‹è§’æ™‚é–“ (Server Time)
                if (res.server_time) {
                    els.serverTime.innerText = new Date(res.server_time).toLocaleTimeString();
                }

                updateUIState(res);

            } catch (err) {
                console.error("Status Check Error", err);
                setUIError("ç„¡æ³•é€£ç·šè‡³å¾Œç«¯ä¼ºæœå™¨");
            }
        }

        // 3. æ›´æ–°ä»‹é¢ç‹€æ…‹ (Lock/Unlock)
        function updateUIState(data) {
            // å¦‚æœæ­£åœ¨è™•ç†å ±åˆ°ä¸­ï¼Œæš«æ™‚ä¸æ›´æ–° UI é–å®šç‹€æ…‹ï¼Œä»¥å…æ‰“æ–·æµç¨‹
            if (isProcessing) return;

            if (data.status === 'OPEN') {
                // --- ç³»çµ±é–‹æ”¾ ---
                if (isSystemLocked) {
                    isSystemLocked = false;
                    els.statusBar.className = 'status-bar status-open';
                    els.statusBar.innerHTML = `<i class="fas fa-door-open me-2"></i> ${data.message}`;
                    
                    els.input.disabled = false;
                    els.input.placeholder = "è«‹è¼¸å…¥å“¡ç·¨æˆ–æƒæ QR Code";
                    els.input.focus();
                    
                    els.btn.disabled = false;
                    els.btn.className = "btn btn-primary btn-submit";
                    
                    els.serverStatus.innerText = "é€£ç·šæ­£å¸¸";
                    els.serverStatus.className = "text-success fw-bold";
                }
            } else {
                // --- ç³»çµ±é—œé–‰ / æœªé–‹å§‹ / å·²æˆªæ­¢ ---
                isSystemLocked = true;
                
                let statusClass = 'status-closed';
                let icon = 'fa-ban';
                
                if (data.status === 'NOT_STARTED') {
                    statusClass = 'status-wait';
                    icon = 'fa-hourglass-start';
                } else if (data.status === 'ENDED') {
                    statusClass = 'status-closed';
                    icon = 'fa-stop-circle';
                }

                els.statusBar.className = `status-bar ${statusClass}`;
                els.statusBar.innerHTML = `<i class="fas ${icon} me-2"></i> ${data.message}`;

                els.input.disabled = true;
                els.input.placeholder = "â›” ç³»çµ±ç›®å‰ç¦æ­¢å ±åˆ°";
                els.input.value = ""; // æ¸…ç©ºè¼¸å…¥
                
                els.btn.disabled = true;
                els.btn.className = "btn btn-secondary btn-submit";
                
                els.serverStatus.innerText = "æš«åœæœå‹™";
                els.serverStatus.className = "text-danger";
            }
        }

        function setUIError(msg) {
            isSystemLocked = true;
            els.statusBar.className = 'status-bar status-closed';
            els.statusBar.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> ${msg}`;
            els.input.disabled = true;
            els.input.placeholder = "é€£ç·šéŒ¯èª¤";
            els.btn.disabled = true;
        }

        // 4. è™•ç†å ±åˆ°å‹•ä½œ
        async function handleCheckIn() {
            const code = els.input.value.trim();
            if (!code) return;

            // é–å®šä»‹é¢é˜²æ­¢é€£é»
            isProcessing = true;
            els.input.disabled = true;
            els.btn.disabled = true;
            els.statusBar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> è³‡æ–™é©—è­‰ä¸­...`;

            try {
                // å‘¼å«å¾Œç«¯ API (participants-ipc.js)
                const res = await window.lotteryAPI.invoke('participant:check-in', code);
                
                // é¡¯ç¤ºçµæœ
                showResult(res);

                // æ›´æ–°å ±åˆ°ç¸½æ•¸
                if (res.meta && res.meta.total_checked_in) {
                    els.countBadge.innerText = `å·²å ±åˆ°: ${res.meta.total_checked_in}`;
                }

            } catch (err) {
                showResult({ success: false, message: "ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤: " + err.message });
            } finally {
                // æ¢å¾©ç‹€æ…‹
                isProcessing = false;
                
                // å¦‚æœç³»çµ±é‚„æ˜¯é–‹æ”¾çš„ï¼Œæ¢å¾©è¼¸å…¥æ¡†
                // æˆ‘å€‘å»¶é²ä¸€é»é»æ¢å¾©ï¼Œè®“ä½¿ç”¨è€…çœ‹æ¸…æ¥šçµæœ
                setTimeout(() => {
                    if (!isSystemLocked) {
                        els.input.disabled = false;
                        els.btn.disabled = false;
                        els.input.value = ''; // æ¸…ç©º
                        els.input.focus();    // é‡æ–°èšç„¦
                        // æ¢å¾©ç‹€æ…‹æ–‡å­—
                        els.statusBar.innerHTML = `<i class="fas fa-door-open me-2"></i> ç³»çµ±é–‹æ”¾å ±åˆ°ä¸­`;
                    }
                }, 1500); // 1.5ç§’å¾Œå¯åˆ·ä¸‹ä¸€ç­†
            }
        }

        // 5. é¡¯ç¤ºçµæœèˆ‡æ’­æ”¾éŸ³æ•ˆ
        function showResult(res) {
            // æ¸…é™¤èˆŠçš„ timer
            if (resultTimer) clearTimeout(resultTimer);
            
            els.resultBox.style.display = 'block';
            els.resultBox.className = 'result-box'; // é‡ç½® class

            if (res.success) {
                if (res.is_repeat) {
                    // --- é‡è¤‡å ±åˆ° (é»ƒè‰²) ---
                    els.resultBox.classList.add('res-repeat');
                    els.resIcon.className = "fas fa-exclamation-circle fa-2x me-3 text-warning";
                    els.resTitle.innerText = "âš ï¸ é‡è¤‡å ±åˆ°";
                    els.resName.innerText = res.data.name;
                    els.resDept.innerText = res.data.department || '';
                    
                    const lastTime = res.meta && res.meta.last_checkin ? new Date(res.meta.last_checkin).toLocaleString() : 'æœªçŸ¥';
                    els.resTime.innerText = `æ‚¨å·²æ–¼ [${lastTime}] å®Œæˆå ±åˆ°`;
                    
                    playSound('repeat');

                } else {
                    // --- å ±åˆ°æˆåŠŸ (ç¶ è‰²) ---
                    els.resultBox.classList.add('res-success');
                    els.resIcon.className = "fas fa-check-circle fa-2x me-3 text-success";
                    els.resTitle.innerText = "ğŸ‰ å ±åˆ°æˆåŠŸ";
                    els.resName.innerText = res.data.name;
                    els.resDept.innerText = res.data.department || '';
                    els.resTime.innerText = `å ±åˆ°æ™‚é–“: ${new Date(res.meta.server_time).toLocaleTimeString()}`;
                    
                    // æ ¹æ“šå¾Œç«¯åˆ¤æ–·æ’­æ”¾éŸ³æ•ˆ (VIP æˆ– æ™®é€š)
                    playSound(res.meta.sound || 'success');
                }
            } else {
                // --- å¤±æ•— (ç´…è‰²) ---
                els.resultBox.classList.add('res-error');
                els.resIcon.className = "fas fa-times-circle fa-2x me-3 text-danger";
                els.resTitle.innerText = "âŒ å ±åˆ°å¤±æ•—";
                els.resName.innerText = "";
                els.resDept.innerText = res.message; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                els.resTime.innerText = "";
                
                playSound('error'); // å¯ä»¥åŠ ä¸€å€‹éŒ¯èª¤éŸ³æ•ˆ
            }

            // 5ç§’å¾Œè‡ªå‹•éš±è—çµæœæ¡†
            resultTimer = setTimeout(() => {
                els.resultBox.style.display = 'none';
            }, 5000);
        }

        // 6. éŸ³æ•ˆæ’­æ”¾é‚è¼¯
        function playSound(type) {
            let src = '';
            // å„ªå…ˆä½¿ç”¨å¾Œç«¯å›å‚³çš„è¨­å®š (å¦‚æœæœ‰çš„è©±)
            // é€™è£¡ç°¡å–®æ˜ å°„ï¼šsuccess -> celebrate, vip -> opening, repeat -> exciting
            if (type === 'vip') src = soundSettings.vip;
            else if (type === 'repeat') src = soundSettings.repeat;
            else src = soundSettings.success; // default success

            if (src) {
                els.audio.src = src;
                els.audio.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—(éœ€äº’å‹•):", e));
            }
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
